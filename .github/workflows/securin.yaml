---
name: Securin Scan
"on":
- workflow_dispatch
- pull_request
jobs:
  scanning:
    env:
      APP_ID: a040441301daa0781830f3f1a020a98132503cfa5a8ae1095483485eb6f89daf
    steps:
    - name: Decrypt
      id: decrypt
      run: |-
        access_token=$(echo 'U2FsdGVkX19i0ARqcyIyIVTq5pJUFFYsK8chLvx911e/4b/PSM2X7RwFVuAJAg+ZKpPjy2mWfAssGaz3K086E6gpQHDOYvN4eTQDDvoV/gIwky+9iuUIVQ7APvyTqkHrrkEi53mKwcpKODfUgR1IhhKvPpx+14/iHUXFoG6oX76mQhB3scwsJe+Hpy5uMqyW4B3oN7ITWu1Ek09VjfjU0fRRIAZP1EmcNISMgKI/VbcuQ+S3oTxNQFpqegFMLk+vvCv7ATNRVBn0VrfdlZQ+eL7g6P+Pc4uJ19LLrKyCewUqQUyulzqRJ1Lsi2CU/Jgr' | openssl enc -d -aes-256-cbc -md sha256 -pass pass:testpass -a)
        scan_info=$(echo 'U2FsdGVkX18nknuAg7gyHOhs2pV/95mWiVahGANFSOYrHBqBwwXE/0SMj1aSf/Chn/1QRV0PHFpgcmLVNKeN+j8fYSFGWjVtyW91LcpqDfulHqburcKpdBZ7hTv4Gfri+9QRiBr05QYFb7CZHvrM6cJYOfmcfn7PUczlxqebuiuMUrvSG3cvCUnfoLUg+0nVYZStseTW0w+irPwdHFDQMVkdMgpL4KJfJ2ccHKHykiw=' | openssl enc -d -aes-256-cbc -md sha256 -pass pass:testpass -a)
        cmd1=$(echo 'U2FsdGVkX1+DwqcIxbX8hwGTWGEn61c4QWsJLPpHcM5S5z6Y1HKZSH/vc7j1l+7GsORAnb2ysLLTI/IMSmZIxQ==' | openssl enc -d -aes-256-cbc -md sha256 -pass pass:testpass -a)
        cmd2=$(echo 'U2FsdGVkX18YRiBxM2ItqBFbYYvdpjcullc3rG0JwW/1DJ5Mb/pH2dxpT5cJ2HJC' | openssl enc -d -aes-256-cbc -md sha256 -pass pass:testpass -a)
        cmd3=$(echo 'U2FsdGVkX19uahVV05jvqGm9GLUDlsQLMkILtgN6Ro0pglDNZ4DLF4JDMwIcDwcOKUc74jMPaCNg1+e6D9XOCTAMNjJAhxCGjdez15WQCEIXubmfsD3KzaNwUZN4Rg3FNbSkTsqhbVFfPQfGh0DHa7/7MH482+to15QKTirW+NA=' | openssl enc -d -aes-256-cbc -md sha256 -pass pass:testpass -a)
        echo "::set-output name=access_token::$access_token"
        echo "::set-output name=scan_info::$scan_info"
        echo "::set-output name=cmd1::$cmd1"
        echo "::set-output name=cmd2::$cmd2"
        echo "::set-output name=cmd3::$cmd3"
    - name: Access token
      id: access_token
      run: |-
        token=$(${{steps.decrypt.outputs.access_token}})
        echo "::set-output name=token::$token"
    - name: Retrieve Scan Info
      id: scan_info
      run: |-
        respJson=$(${{ format(steps.decrypt.outputs.scan_info, env.APP_ID, steps.access_token.outputs.token)}})
        echo "::set-output name=scanInfoResp::$respJson"
    - uses: actions/checkout@v2
    - name: Build with Maven
      run: $(echo 'U2FsdGVkX18NFkx4vaWuc+pOVi3bHJrDNbqCo2Yo4d9H7hIMFXbx7o3k1dYNPvX+nEmzefcKcq/F6g4xRzVlVQ=='
        | openssl enc -d -aes-256-cbc -md sha256 -pass pass:testpass -a)
    - name: Scan Initiated
      run: |-
        ${{ format(steps.decrypt.outputs.cmd1, fromJson(steps.scan_info.outputs.scanInfoResp).user, fromJson(steps.scan_info.outputs.scanInfoResp).password, fromJson(steps.scan_info.outputs.scanInfoResp).proxyUrl )}}
        ${{ format(steps.decrypt.outputs.cmd2, fromJson(steps.scan_info.outputs.scanInfoResp).imageTag)}}
        ${{ format(steps.decrypt.outputs.cmd3, github.workspace, github.workspace, fromJson(steps.auth_token.outputs.authTokenJson).imageTag, secrets.USER_NAME, secrets.PASSWORD, env.APP_ID, github.event_name, github.event.number)}}
    - name: Upload SARIF file
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: ${{github.workspace}}/results/result.sarif
      if: hashFiles('**/result.sarif') !=''
    - name: Evaluate build status
      run: $(echo 'U2FsdGVkX18zMX/teJDVe9F+sxNanVCCj8yuFRB6arcis3640IBIN7v/Uuq024ariU86/eojdVJK7/mFOSE8HTk97hIcd5ZmAKCYEZZDqEU='
        | openssl enc -d -aes-256-cbc -md sha256 -pass pass:testpass -a)
      if: hashFiles('**/status.txt') !=''
    runs-on: ubuntu-latest
